# cs3357.conf - Nginx reverse proxy for the CS 3357 web site
# 
# Generated by Chef for <%= node['fqdn'] %>
# Local modifications will be overwritten.

server {
  listen 80;
  server_name <%= node[:cs3357][:domain] %>;

  location / {
    proxy_pass http://127.0.0.1:8080;
    proxy_redirect off;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Protocol http;
    proxy_pass_request_headers on;
  }
}

server {
  listen 443;
  server_name <%= node[:cs3357][:domain] %>;
  keepalive_timeout 5;

  ssl                  on;
  ssl_certificate      /etc/ssl/certs/<%= node[:cs3357][:domain] %>.crt.pem;
  ssl_certificate_key  /etc/ssl/private/<%= node[:cs3357][:domain] %>.key.pem;
  ssl_session_timeout  5m;

  ssl_protocols SSLv3 TLSv1.1 TLSv1.2;
  ssl_ciphers HIGH:!RC4:!MD5:!aNULL:!eNULL:!EXP:!LOW:!MEDIUM;
  ssl_prefer_server_ciphers on;

  location / {
    proxy_pass http://127.0.0.1:8080;
    proxy_redirect off;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Ssl on;
    proxy_set_header X-Forwarded-Protocol https;
    proxy_pass_request_headers on;
  }
}
